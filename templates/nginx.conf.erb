upstream <%= application %> {
  server unix:<%= unicorn_socket %> fail_timeout=0;
}

server {
  listen 0.0.0.0:<%= nginx_port %> default deferred;
  server_name <%= domain_name %>;
  root <%= current_path %>/public;

    # Fix for CVE-2013-4547
    # http://mailman.nginx.org/pipermail/nginx-announce/2013/000125.html
    if ($request_uri ~ " ") {
        return 444;
    }


<% if nginx_redirect_on_http_x_forwarded_proto -%>
  location /healthcheck.txt {
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
    proxy_next_upstream error;
    break;
  }
<% end -%>

  access_log "<%= nginx_access_log -%>";
  error_log  "<%= nginx_error_log -%>";

  location ^~ /assets/ {
    root <%= current_path %>/public;
    gzip_static on;
    expires max;
    add_header Cache-Control public;
  }

  <% if nginx_chrome_frame %>
  add_header "X-UA-Compatible" "IE=Edge,chrome=1";
  <% end %>

  try_files $uri/index.html $uri @<%= application %>;
  location @<%= application %> {


  <% if nginx_redirect_on_http_x_forwarded_proto -%>
    if ($http_x_forwarded_proto != "https") {
    rewrite        ^ https://$host$request_uri? permanent;
    }
  <% end -%>

  
  <% if fetch(:enable_basic_auth,false) -%>
    auth_basic "<%= application -%> Restricted";                                
    auth_basic_user_file <%= htpasswd_file -%>;
  <% end -%>

    proxy_pass http://<%= application %>;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
  }

  <% if nginx_error_pages %>
  error_page 500 502 503 504 /500.html;
  <% end %>
  client_max_body_size 4G;
  keepalive_timeout 10;
}
